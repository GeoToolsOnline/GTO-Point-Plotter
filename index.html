<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Interactive Map: CSV → Markers + Converters</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/proj4@2.9.2/dist/proj4.js"></script>
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; width: 100vw; }
    .panel { position:absolute; bottom:10px; left:10px; z-index:1000; background:white; padding:8px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,.3); font-family:system-ui, Arial, sans-serif; font-size:14px; }
    .panel h3 { margin:0 0 6px 0; font-size:14px; }
    .row { display:flex; gap:8px; margin:6px 0; align-items:center; }
    .row label { white-space:nowrap; }
    .row select, .row input[type="text"], .row input[type="number"] { padding:4px; }
    .btn { cursor:pointer; padding:6px 10px; border-radius:6px; border:1px solid #ccc; background:#fff; }
    .btn:hover { background:#f3f3f3; }
    .pill { display:inline-block; padding:2px 6px; border-radius:999px; background:#efefef; font-size:12px; }
    #mapping-panel { display:none; max-width: 420px; }
  </style>
</head>
<body>
  <script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js" data-name="bmc-button" data-slug="geotoolsonline" data-color="#FFDD00" data-emoji="☕" data-font="Cookie" data-text="Buy me a coffee" data-outline-color="#000000" data-font-color="#000000" data-coffee-color="#ffffff"></script>

  <div id="map"></div>

  <!-- Bottom-left controls -->
  <div class="panel" style="bottom:10px;left:10px;">
    <div class="row"><input type="file" id="upload" accept=".csv" class="btn"></div>
    <div class="row">
      <button id="toggle" class="btn" title="Toggle imagery/streets">Toggle Map</button>
      <button id="measure" class="btn" title="Measure multi-segment distance">Measure</button>
    </div>
    <div class="row">
      <label>Marker Icon:</label>
      <select id="icon-select">
        <option value="blue">Blue</option>
        <option value="red">Red</option>
        <option value="green">Green</option>
        <option value="gold">Gold</option>
        <option value="star">Star</option>
      </select>
    </div>
    <div class="row">
      <button id="save-kml" class="btn">Save KML</button>
      <button id="save-csv" class="btn">Save CSV</button>
    </div>
    <div class="row"><span class="pill">Tip: right‑click the map to finish measuring</span></div>
  </div>

  <!-- Mapping panel shown after CSV is selected -->
  <div id="mapping-panel" class="panel">
    <h3>CSV Column Mapping</h3>
    <div class="row">
      <label for="coord-type">Coords:</label>
      <select id="coord-type">
        <option value="wgs84">WGS84 (lat, lon)</option>
        <option value="utm">UTM (E, N)</option>
        <option value="osgb">OSGB BNG (E, N)</option>
      </select>
    </div>
    <div class="row">
      <label for="name-col">Name:</label>
      <select id="name-col"></select>
    </div>
    <div class="row">
      <label id="x-label" for="x-col">Lon / Easting (X):</label>
      <select id="x-col"></select>
    </div>
    <div class="row">
      <label id="y-label" for="y-col">Lat / Northing (Y):</label>
      <select id="y-col"></select>
    </div>
    <div id="utm-extra" style="display:none;">
      <div class="row">
        <label for="utm-zone">UTM Zone:</label>
        <input type="number" id="utm-zone" min="1" max="60" placeholder="e.g., 30">
        <label for="utm-hemi">Hemisphere:</label>
        <select id="utm-hemi">
          <option value="N">North</option>
          <option value="S">South</option>
        </select>
      </div>
    </div>
    <div class="row" style="justify-content:flex-end; gap:8px;">
      <button id="cancel-mapping" class="btn">Cancel</button>
      <button id="apply-mapping" class="btn">Load Points</button>
    </div>
  </div>

  <script>
    // --- Projections ---
    proj4.defs("EPSG:27700", 
      "+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 " +
      "+ellps=airy +towgs84=446.448,-125.157,542.06,0.1502,0.2470,0.8421,-20.4894 +units=m +no_defs");

    function utmDef(zone, hemi) {
      const south = (hemi === 'S') ? ' +south' : '';
      return `+proj=utm +zone=${zone}${south} +datum=WGS84 +units=m +no_defs`;
    }

    // --- Map setup ---
    const map = L.map('map', { maxZoom: 19 }).setView([20, 0], 2);

    const imagery = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      { attribution: 'Tiles © Esri & contributors', maxZoom: 19 }
    ).addTo(map);

    const streets = L.tileLayer(
      'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      { attribution: '© OpenStreetMap contributors', maxZoom: 19 }
    );

    let currentBase = 'imagery';

    // --- State ---
    const markers = [];
    let measuring = false;
    let measureLatLngs = []; // Leaflet LatLngs
    let measureLine = null;  // main line
    let measurePreview = null; // dashed segment to cursor
    let measureTooltip = null; // running total

    // For CSV mapping
    let uploadedRows = [];
    let header = [];

    // --- Helpers ---
    function getIcon(type) {
      const urlMap = {
        blue:  "https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png",
        red:   "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
        green: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png",
        gold:  "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-gold.png",
        star:  "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-yellow.png"
      };
      return L.icon({
        iconUrl: urlMap[type],
        shadowUrl: "https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png",
        iconSize: [25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41]
      });
    }

    function addMarker(lat, lon, name = null) {
      const iconType = document.getElementById('icon-select').value;
      if (!name) name = prompt('Enter point name:', 'Point ' + (markers.length + 1)) || 'Point';
      const m = L.marker([lat, lon], { icon: getIcon(iconType) }).addTo(map);
      m.bindTooltip(name, { permanent:true, direction:'right', offset:[10,0] }).openTooltip();

      // Right-click delete
      m.on('contextmenu', (e) => {
        e.originalEvent?.preventDefault?.();
        map.removeLayer(m);
        const i = markers.indexOf(m);
        if (i > -1) markers.splice(i, 1);
      });

      // Double-click rename
      m.on('dblclick', () => {
        const newName = prompt('Rename point:', m.getTooltip().getContent());
        if (newName) m.setTooltipContent(newName);
      });

      markers.push(m);
      return m;
    }

    function snapToMarkers() {
      if (markers.length > 0) {
        const b = L.latLngBounds(markers.map(m => m.getLatLng()));
        map.fitBounds(b, { padding:[50,50], maxZoom:17 }); // cap to avoid imagery "no data"
      }
    }

    // Simple CSV parser supporting quoted fields
    function parseCSV(text) {
      const rows = []; let row = []; let i = 0; let field = ''; let inQuotes = false;
      while (i < text.length) {
        const c = text[i];
        if (inQuotes) {
          if (c === '"') {
            if (text[i+1] === '"') { field += '"'; i++; } else { inQuotes = false; }
          } else { field += c; }
        } else {
          if (c === '"') { inQuotes = true; }
          else if (c === ',') { row.push(field.trim()); field = ''; }
          else if (c === '\n' || c === '\r') {
            if (field.length || row.length) { row.push(field.trim()); rows.push(row); }
            field = ''; row = [];
            // handle \r\n combos
            if (c === '\r' && text[i+1] === '\n') i++;
          } else { field += c; }
        }
        i++;
      }
      if (field.length || row.length) { row.push(field.trim()); rows.push(row); }
      return rows.filter(r => r.length && r.some(v => v !== ''));
    }

    function showMappingPanel() {
      const panel = document.getElementById('mapping-panel');
      panel.style.display = 'block';
    }
    function hideMappingPanel() {
      const panel = document.getElementById('mapping-panel');
      panel.style.display = 'none';
    }

    function populateMappingControls() {
      const nameSel = document.getElementById('name-col');
      const xSel = document.getElementById('x-col');
      const ySel = document.getElementById('y-col');
      [nameSel, xSel, ySel].forEach(sel => { sel.innerHTML = ''; });
      header.forEach((h, idx) => {
        const opt1 = new Option(h, idx); nameSel.add(opt1);
        const opt2 = new Option(h, idx); xSel.add(opt2);
        const opt3 = new Option(h, idx); ySel.add(opt3);
      });

      // Best-guess defaults
      const lower = header.map(h => h.toLowerCase());
      function idxOf(keys) { for (const k of keys) { const i = lower.findIndex(h => h.includes(k)); if (i !== -1) return i; } return 0; }
      nameSel.value = String(idxOf(['name', 'id', 'label']));
      document.getElementById('coord-type').value = 'wgs84';
      xSel.value = String(idxOf(['lon', 'lng', 'long', 'x']));
      ySel.value = String(idxOf(['lat', 'y']));
    }

    function toNumber(s) { const n = parseFloat(String(s).replace(/[^0-9+\-.]/g, '')); return isNaN(n) ? null : n; }

    function addRowAsMarker(row, mapping) {
      const name = mapping.nameIdx != null ? row[mapping.nameIdx] : '';
      let lat = null, lon = null;
      const X = toNumber(row[mapping.xIdx]);
      const Y = toNumber(row[mapping.yIdx]);

      if (mapping.type === 'wgs84') {
        lon = X; lat = Y; // x=lon, y=lat
      } else if (mapping.type === 'utm') {
        if (X != null && Y != null) {
          const def = utmDef(mapping.utmZone, mapping.utmHemi);
          const [lonW, latW] = proj4(def, proj4.WGS84, [X, Y]);
          lon = lonW; lat = latW;
        }
      } else if (mapping.type === 'osgb') {
        if (X != null && Y != null) {
          const [lonW, latW] = proj4('EPSG:27700', proj4.WGS84, [X, Y]);
          lon = lonW; lat = latW;
        }
      }

      if (lat != null && lon != null && isFinite(lat) && isFinite(lon)) {
        addMarker(lat, lon, name || null);
        return true;
      }
      return false;
    }

    // --- File upload & mapping ---
    document.getElementById('upload').addEventListener('change', (evt) => {
      const file = evt.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const text = e.target.result;
        const rows = parseCSV(text);
        if (!rows.length) { alert('CSV appears empty.'); return; }
        uploadedRows = rows;
        header = rows[0];
        populateMappingControls();
        showMappingPanel();
      };
      reader.readAsText(file);
    });

    document.getElementById('coord-type').addEventListener('change', (e) => {
      const type = e.target.value;
      const utmExtra = document.getElementById('utm-extra');
      const xLabel = document.getElementById('x-label');
      const yLabel = document.getElementById('y-label');
      if (type === 'utm') { utmExtra.style.display = 'block'; xLabel.textContent = 'Easting (X)'; yLabel.textContent = 'Northing (Y)'; }
      else if (type === 'osgb') { utmExtra.style.display = 'none'; xLabel.textContent = 'Easting (X)'; yLabel.textContent = 'Northing (Y)'; }
      else { utmExtra.style.display = 'none'; xLabel.textContent = 'Longitude (X)'; yLabel.textContent = 'Latitude (Y)'; }
    });

    document.getElementById('cancel-mapping').addEventListener('click', hideMappingPanel);

    document.getElementById('apply-mapping').addEventListener('click', () => {
      const type = document.getElementById('coord-type').value;
      const nameIdx = parseInt(document.getElementById('name-col').value);
      const xIdx = parseInt(document.getElementById('x-col').value);
      const yIdx = parseInt(document.getElementById('y-col').value);
      const mapping = { type, nameIdx, xIdx, yIdx };
      if (type === 'utm') {
        const z = parseInt(document.getElementById('utm-zone').value);
        const h = document.getElementById('utm-hemi').value;
        if (!z || z < 1 || z > 60) { alert('Please provide a valid UTM zone (1–60).'); return; }
        mapping.utmZone = z; mapping.utmHemi = h;
      }

      let okCount = 0;
      for (let i = 1; i < uploadedRows.length; i++) {
        okCount += addRowAsMarker(uploadedRows[i], mapping) ? 1 : 0;
      }
      hideMappingPanel();
      if (okCount === 0) alert('No valid rows were plotted. Check your column mapping/values.');
      snapToMarkers();
    });

    // --- Basemap toggle ---
    document.getElementById('toggle').addEventListener('click', () => {
      if (currentBase === 'imagery') { map.removeLayer(imagery); streets.addTo(map); currentBase = 'streets'; }
      else { map.removeLayer(streets); imagery.addTo(map); currentBase = 'imagery'; }
    });

    // --- Measuring tool ---
    document.getElementById('measure').addEventListener('click', () => {
      measuring = true;
      clearMeasureGraphics();
      alert('Measuring: click multiple points. Right-click the map to finish, or press Esc to cancel.');
    });

    map.on('click', (e) => {
      if (measuring) {
        measureLatLngs.push(e.latlng);
        updateMeasureLine();
        return;
      }
      // normal click adds marker
      addMarker(e.latlng.lat, e.latlng.lng);
    });

    map.on('mousemove', (e) => {
      if (!measuring || measureLatLngs.length === 0) return;
      const last = measureLatLngs[measureLatLngs.length - 1];
      const previewLatLngs = [last, e.latlng];
      if (measurePreview) map.removeLayer(measurePreview);
      measurePreview = L.polyline(previewLatLngs, { color: 'blue', dashArray: '4,6' }).addTo(map);

      const coords = measureLatLngs.concat([e.latlng]).map(ll => [ll.lng, ll.lat]);
      const lengthKm = turf.length(turf.lineString(coords), { units: 'kilometers' });
      if (!measureTooltip) {
        measureTooltip = L.tooltip({ permanent: true, direction: 'right' })
          .setLatLng(e.latlng)
          .setContent('Distance: ' + lengthKm.toFixed(2) + ' km')
          .addTo(map);
      } else {
        measureTooltip.setLatLng(e.latlng).setContent('Distance: ' + lengthKm.toFixed(2) + ' km');
      }
    });

    // ✅ Right-click to finish measuring (prevent browser menu)
    map.on('contextmenu', (e) => {
      if (!measuring) return; // allow marker right-clicks when not measuring
      e.originalEvent?.preventDefault?.();
      endMeasuring(true);
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && measuring) { endMeasuring(false); }
    });

    function updateMeasureLine() {
      if (measureLine) map.removeLayer(measureLine);
      measureLine = L.polyline(measureLatLngs, { color: 'blue' }).addTo(map);

      const coords = measureLatLngs.map(ll => [ll.lng, ll.lat]);
      const lengthKm = turf.length(turf.lineString(coords), { units: 'kilometers' });
      const anchor = measureLatLngs[measureLatLngs.length - 1];
      if (!measureTooltip) {
        measureTooltip = L.tooltip({ permanent: true, direction: 'right' })
          .setLatLng(anchor)
          .setContent('Distance: ' + lengthKm.toFixed(2) + ' km')
          .addTo(map);
      } else {
        measureTooltip.setLatLng(anchor).setContent('Distance: ' + lengthKm.toFixed(2) + ' km');
      }
    }

    function clearMeasureGraphics() {
      if (measureTooltip) { map.removeLayer(measureTooltip); measureTooltip = null; }
      if (measurePreview) { map.removeLayer(measurePreview); measurePreview = null; }
      if (measureLine) { map.removeLayer(measureLine); measureLine = null; }
      measureLatLngs = [];
    }

    function endMeasuring(keepLine) {
      if (!keepLine && measureLine) { map.removeLayer(measureLine); measureLine = null; }
      if (measurePreview) { map.removeLayer(measurePreview); measurePreview = null; }
      if (measureTooltip) { map.removeLayer(measureTooltip); measureTooltip = null; }
      measuring = false;
      measureLatLngs = [];
    }

    // --- Save KML ---
    document.getElementById('save-kml').addEventListener('click', () => {
      if (markers.length === 0) { alert('No points to save.'); return; }
      let kml = `<?xml version="1.0" encoding="UTF-8"?>\n<kml xmlns="http://www.opengis.net/kml/2.2">\n<Document>\n`;
      markers.forEach((m) => {
        const { lat, lng } = m.getLatLng();
        const name = m.getTooltip().getContent();
        kml += `<Placemark><name>${escapeXml(name)}</name><Point><coordinates>${lng},${lat},0</coordinates></Point></Placemark>\n`;
      });
      kml += `</Document></kml>`;
      const blob = new Blob([kml], { type: 'application/vnd.google-earth.kml+xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'points.kml'; a.click(); URL.revokeObjectURL(url);
    });

    // --- Save CSV with WGS84 + UTM + OSGB ---
    document.getElementById('save-csv').addEventListener('click', () => {
      if (markers.length === 0) { alert('No points to save.'); return; }
      let rows = [
        ['name','latitude','longitude','utm_easting','utm_northing','utm_zone','utm_hemisphere','osgb_easting','osgb_northing']
      ];
      markers.forEach(m => {
        const { lat, lng } = m.getLatLng();
        const name = m.getTooltip().getContent();
        // Compute UTM zone/hemisphere
        const zone = Math.floor((lng + 180) / 6) + 1;
        const hemi = lat >= 0 ? 'N' : 'S';
        const [Eutm, Nutm] = proj4(utmDef(zone, hemi), [lng, lat]);
        const [Eos, Nos] = proj4('EPSG:27700', [lng, lat]);
        rows.push([
          name,
          lat.toFixed(8),
          lng.toFixed(8),
          (Eutm||0).toFixed(3),
          (Nutm||0).toFixed(3),
          zone,
          hemi,
          (Eos||0).toFixed(3),
          (Nos||0).toFixed(3)
        ]);
      });
      const csv = rows.map(r => r.map(v => /[",\n]/.test(String(v)) ? `"${String(v).replace(/"/g,'""')}"` : v).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'points_converted.csv'; a.click(); URL.revokeObjectURL(url);
    });

    function escapeXml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&apos;');}

  </script>
</body>
</html>
